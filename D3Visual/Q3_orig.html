<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>d3 eda (tiny + filters)</title>
<style>
  body{font-family:-apple-system,Segoe UI,Roboto,sans-serif;margin:16px}
  h2{margin:22px 0 6px}
  .axis text{font-size:10px}
  .legend text{font-size:12px}
  #filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 16px}
</style>
</head>
<body>
<h1>Exploratory Data Analysis (D3)</h1>

<div id="filters">
  <label>Panel: <select id="fPanel"></select></label>
  <label>IgG: <select id="fIgg"></select></label>
  <label>Sample: <input id="fSample" placeholder="e.g. S-001" style="padding:3px 6px;width:140px"></label>
  <label>From: <input type="date" id="fFrom"></label>
  <label>To: <input type="date" id="fTo"></label>
  <button id="fApply">Apply</button>
  <button id="fReset">Reset</button>
</div>

<h2>1) Tests over time (by month)</h2><div id="c1"></div>
<h2>2) Tests over time by <code>panel</code> (stacked)</h2><div id="c2"></div>
<h2>3) Days from symptom onset</h2><div id="c3"></div>
<h2>4) IgG agreement over time (100% stacked)</h2><div id="c4"></div>
<h2>5) % Correct by <code>sample_id</code> (True* vs others)</h2><div id="c5"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const CSV="eda_output2.csv"; // add ?v=5 if cache mad
const w=960,h=420,m={t:30,r:20,b:60,l:60}, iw=w-m.l-m.r, ih=h-m.t-m.b;
const pY=d3.utcParse("%Y-%m-%d"), pYH=d3.utcParse("%Y-%m-%d %H:%M:%S"), pM=d3.utcParse("%m/%d/%y");
const toD=v=>v instanceof Date?v:(pY(v)||pYH(v)||pM(v)||null);
const iggCats=["True Positive","True Negative","False Positive","False Negative","NA"];
const iggColor=d3.scaleOrdinal(iggCats,["#6baed6","#74c476","#fd8d3c","#e34a33","#bdbdbd"]);
const S=sel=>d3.select(sel).append("svg").attr("width",w).attr("height",h).append("g").attr("transform",`translate(${m.l},${m.t})`);
const axX=(svg,x)=>svg.append("g").attr("transform",`translate(0,${ih})`).attr("class","axis").call(x);
const axY=(svg,y,f)=>svg.append("g").attr("class","axis").call(f?d3.axisLeft(y).ticks(5,f):d3.axisLeft(y));
const lab=(svg,xl,yl)=>{svg.append("text").attr("x",iw/2).attr("y",-8).attr("text-anchor","middle").style("font-weight",600).text(`${yl} by ${xl}`);
svg.append("text").attr("x",iw/2).attr("y",ih+45).attr("text-anchor","middle").text(xl);
svg.append("text").attr("transform","rotate(-90)").attr("x",-ih/2).attr("y",-45).attr("text-anchor","middle").text(yl);};

let FULL=[];

function applyFilters(){
  let d=FULL.slice();
  const p=document.getElementById("fPanel").value;
  const i=document.getElementById("fIgg").value;
  const s=(document.getElementById("fSample").value||"").toLowerCase();
  const f=document.getElementById("fFrom").value;
  const t=document.getElementById("fTo").value;
  if(p&&p!=="All") d=d.filter(r=>r.panel===p);
  if(i&&i!=="All") d=d.filter(r=>r.igg_agree===i);
  if(s) d=d.filter(r=>(r.sample_id||"").toLowerCase().includes(s));
  if(f){const F=toD(f); d=d.filter(r=>r.date_performed && r.date_performed>=F);}
  if(t){const T=toD(t); d=d.filter(r=>r.date_performed && r.date_performed<=T);}
  return d;
}

function populateFilters(){
  const panels=Array.from(new Set(FULL.map(d=>d.panel))).filter(Boolean).sort();
  const iggs=Array.from(new Set(FULL.map(d=>d.igg_agree))).filter(Boolean).sort();
  d3.select("#fPanel").selectAll("option").data(["All",...panels]).join("option").attr("value",d=>d).text(d=>d);
  d3.select("#fIgg").selectAll("option").data(["All",...iggs]).join("option").attr("value",d=>d).text(d=>d);
  const dates=FULL.map(d=>d.date_performed).filter(d=>d instanceof Date && !isNaN(+d));
  if(dates.length){
    d3.select("#fFrom").property("value", d3.utcFormat("%Y-%m-%d")(d3.min(dates)));
    d3.select("#fTo").property("value", d3.utcFormat("%Y-%m-%d")(d3.max(dates)));
  }
}

function drawAll(D){
  d3.selectAll("#c1 svg,#c2 svg,#c3 svg,#c4 svg,#c5 svg").remove();

  // 1) by month
  (function(){
    const month=d=>d3.utcMonth(d);
    const rows=d3.rollups(D.filter(d=>d.date_performed), v=>v.length, d=>month(d.date_performed))
      .map(([m,c])=>({m:new Date(m),c})).sort((a,b)=>d3.ascending(a.m,b.m));
    const x=d3.scaleUtc().domain(d3.extent(rows,d=>d.m)).range([0,iw]);
    const y=d3.scaleLinear().domain([0,d3.max(rows,d=>d.c)||1]).nice().range([ih,0]);
    const svg=S("#c1"), bw=Math.max(2,(x(d3.utcMonth.offset(x.domain()[0],1))-x(x.domain()[0]))*0.85);
    svg.selectAll("rect").data(rows).join("rect").attr("x",d=>x(d.m)+1).attr("y",d=>y(d.c)).attr("width",bw).attr("height",d=>y(0)-y(d.c)).attr("fill","#444").append("title").text(d=>`${d.m.toISOString().slice(0,7)}: ${d.c}`);
    axX(svg,d3.axisBottom(x).ticks(d3.utcMonth.every(2)).tickFormat(d3.utcFormat("%Y-%m"))); axY(svg,y); lab(svg,"date_performed (month)","count");
  })();

  // 2) stacked by panel
  (function(){
    const rows=D.filter(d=>d.date_performed && d.panel), month=d=>d3.utcMonth(d);
    const keys=Array.from(new Set(rows.map(d=>d.panel))).sort();
    const mat=d3.rollups(rows, v=>{const r={m:month(v[0].date_performed)}, g=d3.rollup(v,vv=>vv.length,d=>d.panel); keys.forEach(k=>r[k]=g.get(k)||0); return r;}, d=>month(d.date_performed)).map(([,r])=>r).sort((a,b)=>d3.ascending(a.m,b.m));
    const x=d3.scaleUtc().domain(d3.extent(mat,d=>d.m)).range([0,iw]);
    const series=d3.stack().keys(keys)(mat);
    const y=d3.scaleLinear().domain([0,d3.max(series,s=>d3.max(s,d=>d[1]))||1]).nice().range([ih,0]);
    const col=d3.scaleOrdinal(keys,d3.schemeTableau10);
    const svg=S("#c2"), bw=Math.max(2,(x(d3.utcMonth.offset(x.domain()[0],1))-x(x.domain()[0]))*0.85);
    svg.append("g").selectAll("g").data(series).join("g").attr("fill",s=>col(s.key))
      .selectAll("rect").data(d=>d).join("rect").attr("x",d=>x(d.data.m)+1).attr("y",d=>y(d[1])).attr("width",bw).attr("height",d=>y(d[0])-y(d[1]))
      .append("title").text(d=>`${d.data.m.toISOString().slice(0,7)}: ${d[1]-d[0]}`);
    axX(svg,d3.axisBottom(x).ticks(d3.utcMonth.every(2)).tickFormat(d3.utcFormat("%Y-%m"))); axY(svg,y); lab(svg,"date_performed (month)","count");
    const lg=svg.append("g").attr("class","legend").attr("transform",`translate(${iw-120},0)`); lg.append("text").text("panel").attr("y",-10).style("font-weight",600);
    const it=lg.selectAll("g").data(keys).join("g").attr("transform",(d,i)=>`translate(0,${i*20})`); it.append("rect").attr("width",14).attr("height",14).attr("fill",d=>col(d)); it.append("text").attr("x",20).attr("y",11).text(d=>d);
  })();

  // 3) histogram
  (function(){
    const arr=D.map(d=>d.days_from_symptom).filter(Number.isFinite);
    const x=d3.scaleLinear().domain(d3.extent(arr)).nice().range([0,iw]);
    const bins=d3.bin().domain(x.domain()).thresholds(30)(arr);
    const y=d3.scaleLinear().domain([0,d3.max(bins,d=>d.length)||1]).nice().range([ih,0]);
    const svg=S("#c3");
    svg.selectAll("rect").data(bins).join("rect").attr("x",d=>x(d.x0)+1).attr("y",d=>y(d.length)).attr("width",d=>Math.max(1,x(d.x1)-x(d.x0)-2)).attr("height",d=>y(0)-y(d.length)).attr("fill","#444").append("title").text(d=>`${d.x0}â€“${d.x1}: ${d.length}`);
    svg.append("g").attr("transform",`translate(0,${y(0)})`).call(d3.axisBottom(x)); axY(svg,y); lab(svg,"days_from_symptom","count");
  })();

  // 4) 100% stacked by igg
  (function(){
    const month=d=>d3.utcMonth(d);
    const rows=d3.rollups(D.filter(d=>d.date_performed), v=>{const tot=v.length,g=d3.rollup(v,vv=>vv.length,d=>iggCats.includes(d.igg_agree)?d.igg_agree:"NA"); const r={m:month(v[0].date_performed)}; iggCats.forEach(k=>r[k]=(g.get(k)||0)/tot); return r;}, d=>month(d.date_performed)).map(([,r])=>r).sort((a,b)=>d3.ascending(a.m,b.m));
    const x=d3.scaleUtc().domain(d3.extent(rows,d=>d.m)).range([0,iw]);
    const y=d3.scaleLinear().domain([0,1]).range([ih,0]);
    const series=d3.stack().keys(iggCats)(rows);
    const svg=S("#c4"), bw=Math.max(2,(x(d3.utcMonth.offset(x.domain()[0],1))-x(x.domain()[0]))*0.85);
    svg.append("g").selectAll("g").data(series).join("g").attr("fill",d=>iggColor(d.key))
      .selectAll("rect").data(d=>d).join("rect").attr("x",d=>x(d.data.m)+1).attr("y",d=>y(d[1])).attr("width",bw).attr("height",d=>y(d[0])-y(d[1]))
      .append("title").text(d=>d3.format(".0%")(d[1]-d[0]));
    axX(svg,d3.axisBottom(x).ticks(d3.utcMonth.every(2)).tickFormat(d3.utcFormat("%Y-%m"))); axY(svg,y,"%"); lab(svg,"date_performed (month)","proportion");
    const order=["False Negative","False Positive","True Negative","True Positive","NA"];
    const lg=svg.append("g").attr("class","legend").attr("transform",`translate(${iw-150},0)`); lg.append("text").text("igg_agree").attr("y",-10).style("font-weight",600);
    const it=lg.selectAll("g").data(order).join("g").attr("transform",(d,i)=>`translate(0,${i*20})`); it.append("rect").attr("width",14).attr("height",14).attr("fill",d=>iggColor(d)); it.append("text").attr("x",20).attr("y",11).text(d=>d);
  })();

  // 5) % correct by sample_id
  (function(){
    const rows=d3.rollups(D.filter(d=>d.sample_id), v=>v.filter(r=>(r.igg_agree+"").startsWith("True")).length/(v.length||1), d=>d.sample_id)
      .map(([sample_id,pct])=>({sample_id,pct})).filter(d=>Number.isFinite(d.pct)).sort((a,b)=>d3.ascending(a.pct,b.pct));
    const iw2=Math.max(iw, rows.length*8), x=d3.scaleBand().domain(rows.map(d=>d.sample_id)).range([0,iw2]).padding(0.1), y=d3.scaleLinear().domain([0,1]).range([ih,0]);
    const svg=d3.select("#c5").append("div").style("overflow-x","auto").append("svg").attr("width",iw2+m.l+m.r).attr("height",h).append("g").attr("transform",`translate(${m.l},${m.t})`);
    svg.selectAll("rect").data(rows).join("rect").attr("x",d=>x(d.sample_id)).attr("y",d=>y(d.pct)).attr("width",x.bandwidth()).attr("height",d=>y(0)-y(d.pct)).attr("fill","#444").append("title").text(d=>d3.format(".1%")(d.pct));
    svg.append("g").attr("transform",`translate(0,${y(0)})`).call(d3.axisBottom(x).tickValues([])); axY(svg,y,"%"); lab(svg,"sample_id","% Correct");
  })();
}

d3.csv(CSV, d=>({...d,
  date_performed: toD(d.date_performed),
  days_from_symptom: d.days_from_symptom==null? null : +d.days_from_symptom,
  igg_agree: d.igg_agree ?? "NA", panel: d.panel ?? "NA", sample_id: d.sample_id ?? "NA"
})).then(raw=>{
  FULL=raw; populateFilters(); drawAll(FULL);
  document.getElementById("fApply").onclick=()=>drawAll(applyFilters());
  document.getElementById("fReset").onclick=()=>{ populateFilters(); drawAll(FULL); };
  // live-change if you like:
  ["fPanel","fIgg","fSample","fFrom","fTo"].forEach(id=>document.getElementById(id).onchange=()=>drawAll(applyFilters()));
}).catch(e=>{console.error(e); alert("csv load failed");});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>IgM / IgG — Scatter + Elbow + K-Means</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family:-apple-system, Segoe UI, Roboto, sans-serif; margin:18px; }
    h2 { margin:18px 0 8px; font-size:18px; font-weight:700; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(520px, 1fr)); gap:18px; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.05); }
    .card h4 { margin:0 0 8px; font-weight:600; }
    svg { display:block; }
    .axis text { font-size:11px; }
    .axis path, .axis line { stroke:#d0d0d0; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .legend-item { display:inline-flex; align-items:center; gap:6px; font-size:12px; }
    .swatch { width:12px; height:12px; border-radius:3px; display:inline-block; }
    .error { color:#b00020; margin:8px 0; }
  </style>
</head>
<body>

<div id="msg" class="error"></div>

<!-- Section 1: Basic Scatter -->
<h2>1) Scatter (Raw TP vs FP)</h2>
<div class="grid">
  <div class="card"><h4>IgM — Raw Scatter</h4><div id="igm-basic"></div></div>
  <div class="card"><h4>IgG — Raw Scatter</h4><div id="igg-basic"></div></div>
</div>

<!-- Section 2: K-Means Scatter -->
<h2>2) K-Means Clusters (k=6)</h2>
<div class="grid">
  <div class="card"><h4>IgM — K-Means Clusters</h4><div id="igm-kmeans"></div><div id="igm-legend" class="legend"></div></div>
  <div class="card"><h4>IgG — K-Means Clusters</h4><div id="igg-kmeans"></div><div id="igg-legend" class="legend"></div></div>
</div>

<!-- Section 3: Elbow -->
<h2>3) Elbow (k vs Inertia)</h2>
<div class="grid">
  <div class="card"><h4>IgM — Elbow</h4><div id="igm-elbow"></div></div>
  <div class="card"><h4>IgG — Elbow</h4><div id="igg-elbow"></div></div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const FILES = {
    igmRaw: "df_igm_metrics.csv",
    iggRaw: "df_igg_metrics.csv",
    igmElbow: "igm_elbow.csv",
    iggElbow: "igg_elbow.csv",
    igmClusters: "igm_clusters_k6.csv",
    iggClusters: "igg_clusters_k6.csv"
  };

  const BASE = new URL(".", location.href);
  const urlOf = f => new URL(f, BASE).toString();

  const W=520, H=420, M={top:22,right:16,bottom:44,left:48};
  const iw=W-M.left-M.right, ih=H-M.top-M.bottom;

  const msg = document.getElementById("msg");
  const showError = t => { console.error(t); msg.textContent = t; };
  const color = d3.scaleOrdinal(d3.schemeSet2);

  function mk(sel){
    return d3.select(sel).html("")
      .append("svg").attr("width",W).attr("height",H)
      .append("g").attr("transform",`translate(${M.left},${M.top})`);
  }
  function axes(svg,x,y,xLabel,yLabel){
    svg.append("g").attr("class","axis").attr("transform",`translate(0,${ih})`).call(d3.axisBottom(x).ticks(6));
    svg.append("g").attr("class","axis").call(d3.axisLeft(y).ticks(6));
    svg.append("text").attr("x",iw/2).attr("y",ih+34).attr("text-anchor","middle").text(xLabel);
    svg.append("text").attr("transform","rotate(-90)").attr("x",-ih/2).attr("y",-38).attr("text-anchor","middle").text(yLabel);
  }
  function drawCentroidX(svg, x, y, size=8, stroke="red"){
    svg.append("line").attr("x1", x-size).attr("y1", y-size).attr("x2", x+size).attr("y2", y+size).attr("stroke", stroke).attr("stroke-width", 2);
    svg.append("line").attr("x1", x-size).attr("y1", y+size).attr("x2", x+size).attr("y2", y-size).attr("stroke", stroke).attr("stroke-width", 2);
  }
  function legend(containerSel, rows){
    const ids = Array.from(new Set(rows.map(d => +d.cluster))).sort(d3.ascending);
    const cont = d3.select(containerSel).html("");
    ids.forEach(c => {
      const item = cont.append("div").attr("class","legend-item");
      item.append("span").attr("class","swatch").style("background", color(c));
      item.append("span").text(`cluster ${c}`);
    });
  }

  // --- Basic Scatter ---
  function normalizeRow(d){
    const fp = d.FP ?? d.fp ?? d.fpr ?? d.false_positive_rate;
    const tp = d.TP ?? d.tp ?? d.tpr ?? d.true_positive_rate;
    return { device: d.device ?? d.Device ?? "", FP: +fp, TP: +tp };
  }
  function drawBasicScatter(sel, rows, colorVal){
    const data = rows.map(normalizeRow).filter(r => Number.isFinite(r.FP) && Number.isFinite(r.TP));
    const svg = mk(sel);
    const x = d3.scaleLinear().domain([0,1]).range([0,iw]);
    const y = d3.scaleLinear().domain([0,1]).range([ih,0]);
    axes(svg,x,y,"False Positive Rate (FP)","True Positive Rate (TP)");
    svg.selectAll("circle").data(data).join("circle")
      .attr("cx",d=>x(d.FP)).attr("cy",d=>y(d.TP)).attr("r",4).attr("fill",colorVal)
      .append("title").text(d=>`${d.device||"(device)"}\nFP=${d.FP.toFixed(3)}  TP=${d.TP.toFixed(3)}`);
  }

  // --- K-Means Scatter ---
  function drawKMeansScatter(sel, legendSel, rows){
    const data = rows.map(d => ({ device: d.device ?? "", FP:+d.FP, TP:+d.TP, cluster:+d.cluster }))
                     .filter(d => Number.isFinite(d.FP) && Number.isFinite(d.TP));
    const svg = mk(sel);
    const x = d3.scaleLinear().domain([0,1]).range([0,iw]);
    const y = d3.scaleLinear().domain([0,1]).range([ih,0]);
    axes(svg,x,y,"False Positive Rate (FP)","True Positive Rate (TP)");

    svg.selectAll("circle.pt").data(data).join("circle")
      .attr("cx",d=>x(d.FP)).attr("cy",d=>y(d.TP)).attr("r",4).attr("fill",d=>color(d.cluster))
      .append("title").text(d=>`${d.device||"(device)"} • cluster ${d.cluster}\nFP=${d.FP.toFixed(3)}  TP=${d.TP.toFixed(3)}`);

    const cents = d3.rollups(data, v => ({ FP: d3.mean(v, d=>d.FP), TP: d3.mean(v, d=>d.TP) }), d => d.cluster)
                    .map(([cluster, c]) => ({ cluster:+cluster, ...c }));
    cents.forEach(c => drawCentroidX(svg, x(c.FP), y(c.TP), 8, "red"));
    legend(legendSel, data);
  }

  // --- Elbow ---
  function drawElbow(sel, data){
    const svg=mk(sel);
    const x=d3.scaleLinear().domain(d3.extent(data, d=>+d.k)).nice().range([0,iw]);
    const y=d3.scaleLinear().domain([0, d3.max(data, d=>+d.inertia)]).nice().range([ih,0]);
    axes(svg,x,y,"k (clusters)","Inertia");
    const line=d3.line().x(d=>x(+d.k)).y(d=>y(+d.inertia));
    svg.append("path").datum(data).attr("fill","none").attr("stroke","#444").attr("stroke-width",2).attr("d",line);
    svg.selectAll("circle.pt").data(data).join("circle")
      .attr("cx",d=>x(+d.k)).attr("cy",d=>y(+d.inertia)).attr("r",3).attr("fill","#444")
      .append("title").text(d=>`k=${d.k}, inertia=${(+d.inertia).toFixed(2)}`);
  }

  // --- Data Loading ---
  Promise.all([
    d3.csv(urlOf(FILES.igmRaw), d3.autoType),
    d3.csv(urlOf(FILES.iggRaw), d3.autoType),
    d3.csv(urlOf(FILES.igmClusters), d3.autoType),
    d3.csv(urlOf(FILES.iggClusters), d3.autoType),
    d3.csv(urlOf(FILES.igmElbow), d3.autoType),
    d3.csv(urlOf(FILES.iggElbow), d3.autoType)
  ])
  .then(([igmRaw, iggRaw, igmClu, iggClu, igmEl, iggEl]) => {
    // 1) Raw scatter plots (top)
    drawBasicScatter("#igm-basic", igmRaw, "#1f77b4");
    drawBasicScatter("#igg-basic", iggRaw, "#ff7f0e");

    // 2) K-means cluster scatter (middle)
    drawKMeansScatter("#igm-kmeans", "#igm-legend", igmClu);
    drawKMeansScatter("#igg-kmeans", "#igg-legend", iggClu);

    // 3) Elbow plots (bottom)
    drawElbow("#igm-elbow", igmEl);
    drawElbow("#igg-elbow", iggEl);
  })
  .catch(err => { showError("Failed to load CSVs."); console.error(err); });

});
</script>
</body>
</html>

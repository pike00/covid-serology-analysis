<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>D3 EDA (CDN)</title>
  <style>
    body { font-family:-apple-system, Segoe UI, Roboto, sans-serif; margin:18px; }
    h1 { margin-bottom:4px; }
    h2 { margin:28px 0 6px; }
    .chart { margin-bottom:26px; }
    .axis text { font-size:11px; }
    .axis path, .axis line { stroke:#999; shape-rendering:crispEdges; }
    .legend { font-size:12px; }
    .tooltip { position:absolute; pointer-events:none; background:rgba(0,0,0,.8); color:#fff;
               padding:6px 8px; border-radius:4px; font-size:12px; white-space:nowrap;
               transform:translate(-50%,-120%); opacity:0; }
    .msg { color:#b00; font-size:13px; }
  </style>
</head>
<body>
  <h1>Exploratory Data Analysis (D3)</h1>

  <h2>1) Tests over time (by month)</h2><div id="chart1" class="chart"></div>
  <h2>2) Tests over time by <code>panel</code> (stacked)</h2><div id="chart2" class="chart"></div>
  <h2>3) Days from symptom onset</h2><div id="chart3" class="chart"></div>
  <h2>4) IgG agreement over time (100% stacked)</h2><div id="chart4" class="chart"></div>
  <h2>5) % Correct by <code>sample_id</code> (True* vs others)</h2><div id="chart5" class="chart"></div>

  <!-- CDN versions to avoid local lib mismatch -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/d3-fetch.v3.min.js"></script>

  <script>
  const CSV_PATH = "eda_output2.csv";
  const W=960,H=420,M={top:36,right:20,bottom:70,left:70}, PAD=0.12;
  const tdiv = d3.select("body").append("div").attr("class","tooltip");

  const pYMD=d3.utcParse("%Y-%m-%d"), pYMDHMS=d3.utcParse("%Y-%m-%d %H:%M:%S"), pMDY=d3.utcParse("%m/%d/%y");
  const coerceDate = v => v instanceof Date ? v :
    typeof v==="string" ? (pYMD(v)||pYMDHMS(v)||pMDY(v)||new Date(v)) : null;

  const iggCats=["True Positive","True Negative","False Positive","False Negative","NA"];
  const iggColor=d3.scaleOrdinal().domain(iggCats)
                   .range(["#6baed6","#74c476","#fd8d3c","#e34a33","#bdbdbd"]);

  d3.csv(CSV_PATH, d3.autoType).then(raw=>{
    console.log("Loaded rows:", raw.length, "Columns:", Object.keys(raw[0]||{}));

    const data=raw.map(d=>({
      ...d,
      date_performed: coerceDate(d.date_performed),
      igg_agree: d.igg_agree ?? "NA",
      panel: d.panel ?? "NA",
      sample_id: d.sample_id ?? "NA",
      days_from_symptom: d.days_from_symptom!=null ? +d.days_from_symptom : null
    }));

    // helpers
    const mkSvg = sel => d3.select(sel).append("svg").attr("width",W).attr("height",H)
      .append("g").attr("transform",`translate(${M.left},${M.top})`);
    const xTime = (svg,x,innerH) => svg.append("g").attr("class","axis")
      .attr("transform",`translate(0,${innerH})`)
      .call(d3.axisBottom(x).ticks(d3.utcMonth.every(2)).tickFormat(d3.utcFormat("%Y-%m")));
    const yAxis = (svg,y,fmt=null) => svg.append("g").attr("class","axis").call(fmt? d3.axisLeft(y).ticks(5,fmt): d3.axisLeft(y));
    const msg   = (sel,txt)=> d3.select(sel).append("div").attr("class","msg").text(txt);
    const show  = (e,html)=> tdiv.html(html).style("left",e.pageX+"px").style("top",e.pageY+"px").style("opacity",1);
    const hide  = ()=> tdiv.style("opacity",0);
    const labels=(svg,xLab,yLab)=>{ const iw=W-M.left-M.right, ih=H-M.top-M.bottom;
      svg.append("text").attr("x",iw/2).attr("y",-10).attr("text-anchor","middle").style("font-weight",600).text(`${yLab} by ${xLab}`);
      svg.append("text").attr("x",iw/2).attr("y",ih+50).attr("text-anchor","middle").text(xLab);
      svg.append("text").attr("transform","rotate(-90)").attr("x",-ih/2).attr("y",-50).attr("text-anchor","middle").text(yLab);
    };

    // 1) counts by month
    (()=>{
      const f=data.filter(d=>d.date_performed instanceof Date && !isNaN(+d.date_performed));
      if(!f.length) return msg("#chart1","No valid date_performed values.");
      const month=d=>d3.utcMonth(d);
      const rows=d3.rollups(f,v=>v.length,d=>month(d.date_performed))
                   .map(([m,c])=>({m:new Date(m),c})).sort((a,b)=>d3.ascending(a.m,b.m));
      const iw=W-M.left-M.right, ih=H-M.top-M.bottom;
      const x=d3.scaleUtc().domain(d3.extent(rows,d=>d.m)).range([0,iw]);
      const y=d3.scaleLinear().domain([0,d3.max(rows,d=>d.c)]).nice().range([ih,0]);
      const svg=mkSvg("#chart1");
      const bw=Math.max(2,(x(d3.utcMonth.offset(x.domain()[0],1))-x(x.domain()[0]))*(1-PAD));
      svg.selectAll("rect").data(rows).join("rect")
        .attr("x",d=>x(d.m)+1).attr("y",d=>y(d.c)).attr("width",bw).attr("height",d=>y(0)-y(d.c))
        .attr("fill","#444").on("mousemove",(e,d)=>show(e,`${d.m.toISOString().slice(0,7)}: ${d.c}`)).on("mouseleave",hide);
      xTime(svg,x,ih); yAxis(svg,y); labels(svg,"date_performed (month)","count");
    })();

    // 2) stacked by panel
    (()=>{
      const f=data.filter(d=>d.date_performed instanceof Date && d.panel);
      if(!f.length) return msg("#chart2","No panel/time data.");
      const month=d=>d3.utcMonth(d);
      const keys=Array.from(new Set(f.map(d=>d.panel))).sort();
      const color=d3.scaleOrdinal(keys, d3.schemeTableau10);
      const mat=d3.rollups(f, v=>{
        const r={m:month(v[0].date_performed)}, g=d3.rollup(v, vv=>vv.length, d=>d.panel);
        keys.forEach(k=>r[k]=g.get(k)||0); return r;
      }, d=>month(d.date_performed)).map(([,r])=>r).sort((a,b)=>d3.ascending(a.m,b.m));
      const iw=W-M.left-M.right, ih=H-M.top-M.bottom;
      const x=d3.scaleUtc().domain(d3.extent(mat,d=>d.m)).range([0,iw]);
      const series=d3.stack().keys(keys)(mat);
      const y=d3.scaleLinear().domain([0,d3.max(series,s=>d3.max(s,d=>d[1]))]).nice().range([ih,0]);
      const svg=mkSvg("#chart2");
      const bw=Math.max(2,(x(d3.utcMonth.offset(x.domain()[0],1))-x(x.domain()[0]))*(1-PAD));
      svg.append("g").selectAll("g").data(series).join("g").attr("fill",s=>color(s.key))
        .selectAll("rect").data(d=>d).join("rect")
          .attr("x",d=>x(d.data.m)+1).attr("y",d=>y(d[1])).attr("width",bw).attr("height",d=>y(d[0])-y(d[1]))
          .on("mousemove",(e,d)=>{const k=e.currentTarget.parentNode.__data__.key;show(e,`${d.data.m.toISOString().slice(0,7)}<br>${k}: ${d[1]-d[0]}`)}).on("mouseleave",hide);
      xTime(svg,x,ih); yAxis(svg,y); labels(svg,"date_performed (month)","count");
    })();

    // 3) histogram days_from_symptom
    (()=>{
      const arr=data.map(d=>d.days_from_symptom).filter(Number.isFinite);
      if(!arr.length) return msg("#chart3","No numeric days_from_symptom.");
      const iw=W-M.left-M.right, ih=H-M.top-M.bottom;
      const x=d3.scaleLinear().domain(d3.extent(arr)).nice().range([0,iw]);
      const bins=d3.bin().domain(x.domain()).thresholds(30)(arr);
      const y=d3.scaleLinear().domain([0,d3.max(bins,d=>d.length)]).nice().range([ih,0]);
      const svg=mkSvg("#chart3");
      svg.selectAll("rect").data(bins).join("rect")
        .attr("x",d=>x(d.x0)+1).attr("y",d=>y(d.length)).attr("width",d=>Math.max(1,x(d.x1)-x(d.x0)-2))
        .attr("height",d=>y(0)-y(d.length)).attr("fill","#444")
        .on("mousemove",(e,d)=>show(e,`${d.x0}â€“${d.x1}: ${d.length}`)).on("mouseleave",hide);
      svg.append("g").attr("class","axis").attr("transform",`translate(0,${y(0)})`).call(d3.axisBottom(x));
      yAxis(svg,y); labels(svg,"days_from_symptom","count");
    })();

    // 4) 100% stacked igg_agree over time
    (()=>{
      const f=data.filter(d=>d.date_performed instanceof Date);
      if(!f.length) return msg("#chart4","No valid dates for igg_agree chart.");
      const month=d=>d3.utcMonth(d);
      const rows=d3.rollups(f,v=>{
        const total=v.length, g=d3.rollup(v,vv=>vv.length,d=>iggCats.includes(d.igg_agree)?d.igg_agree:"NA");
        const r={m:month(v[0].date_performed)}; iggCats.forEach(c=>r[c]=(g.get(c)||0)/total); return r;
      }, d=>month(d.date_performed)).map(([,r])=>r).sort((a,b)=>d3.ascending(a.m,b.m));
      const iw=W-M.left-M.right, ih=H-M.top-M.bottom;
      const x=d3.scaleUtc().domain(d3.extent(rows,d=>d.m)).range([0,iw]);
      const series=d3.stack().keys(iggCats)(rows);
      const y=d3.scaleLinear().domain([0,1]).range([ih,0]);
      const svg=mkSvg("#chart4");
      const bw=Math.max(2,(x(d3.utcMonth.offset(x.domain()[0],1))-x(x.domain()[0]))*(1-PAD));
      svg.append("g").selectAll("g").data(series).join("g").attr("fill",d=>iggColor(d.key))
        .selectAll("rect").data(d=>d).join("rect")
          .attr("x",d=>x(d.data.m)+1).attr("y",d=>y(d[1])).attr("width",bw).attr("height",d=>y(d[0])-y(d[1]))
          .on("mousemove",(e,d)=>{const k=e.currentTarget.parentNode.__data__.key;show(e,`${d.data.m.toISOString().slice(0,7)}<br>${k}: ${d3.format(".0%")(d[1]-d[0])}`)}).on("mouseleave",hide);
      xTime(svg,x,ih); yAxis(svg,y,"%"); labels(svg,"date_performed (month)","proportion");
    })();

    // 5) % correct by sample_id
    (()=>{
      const rows=d3.rollups(data.filter(d=>d.sample_id),v=>{
        const n=v.length, correct=v.filter(r=>typeof r.igg_agree==="string" && r.igg_agree.startsWith("True")).length;
        return correct/(n||1);
      }, d=>d.sample_id).map(([sample_id,pct])=>({sample_id,pct}));
      if(!rows.length) return msg("#chart5","No sample_id data.");
      rows.sort((a,b)=>d3.descending(a.pct,b.pct));
      const topN=150, take=rows.slice(0,topN);
      const iw=Math.max(W-M.left-M.right, take.length*8), ih=H-M.top-M.bottom;
      const x=d3.scaleBand().domain(take.map(d=>d.sample_id)).range([0,iw]).padding(0.1);
      const y=d3.scaleLinear().domain([0,1]).range([ih,0]);
      const svgOuter=d3.select("#chart5").append("div").style("overflow-x","auto").append("svg")
        .attr("width",iw+M.left+M.right).attr("height",H);
      const svg=svgOuter.append("g").attr("transform",`translate(${M.left},${M.top})`);
      svg.selectAll("rect").data(take).join("rect")
        .attr("x",d=>x(d.sample_id)).attr("y",d=>y(d.pct)).attr("width",x.bandwidth()).attr("height",d=>y(0)-y(d.pct))
        .attr("fill","#444").on("mousemove",(e,d)=>show(e,`${d.sample_id}: ${d3.format(".1%")(d.pct)}`)).on("mouseleave",hide);
      svg.append("g").attr("class","axis").attr("transform",`translate(0,${y(0)})`).call(d3.axisBottom(x).tickValues([]));
      yAxis(svg,y,"%"); labels(svg,`sample_id (top ${topN})`,"% Correct");
    })();

  }).catch(err=>{
    console.error(err);
    d3.select("#chart1").append("div").attr("class","msg").text("Error loading CSV. See console.");
  });
  </script>
</body>
</html>
